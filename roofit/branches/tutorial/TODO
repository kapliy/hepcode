OCTOBER:
* Finish coding wmunu truth navigator in w asym
  Reconstruct truth BEFORE any kinematic cuts. Only apply cuts in the study or 
  Create unfolding ntuple.
* Check that reco efficiency is applied correctly for zmumu events. What about iso/trig efficiency?
* Re-run October 4 version in TrigFTKAna_trunk with new MCP-curvature offsets.
  Perhaps this will/can fix the ugly hole?
* Re-generate MCP scripts with coarser binning that follows detector geometry
* Finish QCD bg-subtraction estimate.
* Study QCD: saw funny business between MC template vs data-driven.

UNFOLDING AND WEIGHTS:
Consider this simplified example.
Suppose there are no bin-by-bin migrations.
Suppose there are no backgrounds, so the data histogram is already the reco-level signal histogram.
Suppose trigger efficiency scale factor in 0.5 for |eta|<1 and 1.0 otherwise.
I.e., triggered events in data exhibit a ~50% dip in central region, which is not modeled by MC.
Input into unfolding: a data (=signal) histogram that exhibits the dip.
Output from unfolding: a truth-level histogram without a dip.



Peter:
Make a stack plot of W reconstruction vs phi in the specific bin that gives trouble.

Anton:
* Finish bg-subtraction in QCD template.
* Repeat x-vs-eta plots in Z events. Worry: require two trigger matches? Not really, but applying two trigger scale factors
* Check: correctly applying event scale factors for events with multiple particles (muons)?
Peter:
do eta/phi plot. Or eta/phi but divide by large/small muon module.

prepare* script updates:
- DONE get a matrix of QCD scale factors
- DONE get ewk and qcd backgrounds
- DONE get a version of qcd that's scaled using the common scale
- ADD: signed pseudorapidity histograms

Anton: check w PT reweighting with different targets. Include powheg+pythia 8.
Compare w pT and lepton pT
Compare w polarization reweighting for qcd fits.
Add subfolder of all histograms

ABCD: Missing-ET vs Isolation.
In MC, check correlation and correct for it.

Max:
[11:03:46 AM] Massimiliano Bellomo: PowhegPythia for W,Z to muons
[11:03:58 AM] Massimiliano Bellomo: Alpgen for W,Z to tau
[11:04:09 AM] Massimiliano Bellomo: MC@NLO for ttbar and single top
[11:04:19 AM] Massimiliano Bellomo: Herwig for WW,ZZ,WZ
W/Gamma alpgen: 117410-15

2010 paper: table with MCs
8.5% ttbar
5% w/z

Idea: fit in delta-phi between MET and muon
TODO: understand the Z MC veto and drell-yan

ANTON TODO:
* Finish comparing Max cutflow
* Add unfolding tree a-la max
* Do QCD fits from histograms


MAX TODO:
- QCD fits in 2D bins. Add extra histograms to make sure we can fit them!
- make ratio plots of truth level and reco level.
- neutrino pt vs met-truth (to factor out jets)
- compare tunes of powheg/herwig and mc@nlo


MEL TODO:
Plot W pT for different generators
In W rest frame, decay angle (polar angle) of lepton - in slices of W pT
MCP corrections: split in phi bins, for the barrel case where there is large C offset?

Make sure i save the correct eff uncertainty in ntuples!
Check if Max gets a really large trig effuncertainty because he does not use corresponding unfolding matrices!

Peter: why w mt is best.
it factors out w pt. Overlay templates for different generators - expect better agreement between them in w_mt (vs other variables).

Make unfolding TTree a-la max, for all systematics

Consider EtMissRel instead of etmiss?
/home/antonk/ElectroweakBosons/AnalysisZmumu/HFrame/src

ME:
Jan - effect of w polarization. Jan will provide a reweighting class.
* Make table of QCD fit chi2s. Powheg+Pythia has best chi2 even though most stats? Try to reduce the statistics.

* Add dressed muons for C_W factors!
* Utilize DgEventInfo extras to add truth quantities to reco ntuples - for cuts
  This is not quite good for response matrices because it's missing inefficiency terms:(

Follow up: geometric shift could change efficiency.
EM -> JES
LC -> JES


MAX: make fits as a function of eta. 2010 standard.

MAX: MET disagreement in PowHeg - understand
     ABCD: iso - MET

MAX: why muon pt cut not 25 GeV?
MAX: cutflow convergence!
MAX: C_W vs unfolding. Default: born


Understand why MC event counts (CUTFLOW) are rounded to integers!!!

wire up the flag is_syst to skip initialization of many classes, in particular having to do with jet stuffs
MET propagation: see if KC corrections are actually valid for low-pt muons, which are used for MET propagation!
Peter: isolation is very different between b and c. Need to worry about the mix.
For merge jobs, require 4GB of RAM (?)

Max meeting:

Q: discuss statistics issue

Q: chi2 plot script 
   number of sigma
   data-mc / (sum of errors). For fit, chi2 is directly from the fit bin-by-bin. sqrt(chi2). Sign is comparing template to data. MC below - > chi2 contribution positive.

Q: muon efficiency: correlated uncertainty?
   TODO: discuss with MCP - follow up
   TODO: remind about scale - Max will do it

Q: unfolding
   EWUNFOLD - xml unfolding steering.

* I think QCD fits are not normalized correctly in roofit/.
* Add additional isolations. Get rid of extraneous plots (metfit where we don't need it)

Peter: WZ D3PDs have huge truth
Understand why the TFractionFitter metfit fails in some cases yet succeeds if it is attempted one more time. Understand if ewk normalization is floating, and if so, add it to canvas printout
z0 reweighting
* Consider allowing floating normalization to EWK

Check out this line: - it gets triggered on met_phi in Zmumu events.
    if( safe_divide(tmp,den) > 1E6 ) { printf( "num = %f , den = %f\n" , num , den ); return 0; assert(false); } //FIXME AK

Peter: Photos  -> Dressed truth should be the same
FEWZ has no ewk FSR term. -> FEWZ 3.0

Ntuple based studies:
* Compare QCD template shapes as a function of isolation cone.
* Compare data/MC agreement in roofit for tigher cone (0.1)

* CM: ABCD = isolation and MULTIJET_LIKE{met<X && mT<X && nlepton=small}

Work in progress:
* understand njets distribution issues. Isolation? Ntuple/histo difference?
  Re-made the distribution in roofit/stack2.py - looks a lot better. WHY???
* Data driven QCD
* Why data driven backgrounds go in one-sided direction.
* W/Z common meeting.

*Add veto on z mass from non-isolated muons.

* separate run for wmunu pt reweighting for samples with the same PDF.
* add isoww_metfit category to get isolation choice systematic

roofit updates:
[AFTER FIXING HISTO BUG:]
* Compare ntuple-derived and histogram-based asymmetry
[IMMEDIATE:]
* Get back to QCD studies. Make the anti-isolated muon template; normalze via usual fit.
* w pt plots from peter
* Big jordan update


TrigFTKAna updates:
* add tag-probe in.
  hardcode in study class, as Ho Ling does!
* LATER: Add truth-level 4-momentum and njets to reco ntuple (maybe implement global passing via a map in DgEventInfo?)
* LATER: Add FSR tool; add FSR-present flag; add FSR-corrected Z
* LATER: add dressed truth leptons

The scale factors do not depent on pT, but the errors do. So to get
the right errors with the scale factors,  you must use the
fourmomentum before the smearing.

* Mel: compare Pythia and Alpgen pre-FSR distributions.
  Peter: identify and veto events that have an FSR photon around the mu
  Mel: Make reco plots of w pt, see if generator differences wash away
  Peter: make truth plots of asymmetry in w pt bins (0..5 GeV)
* Choose MC truth correctly: Alpgen status != 1, but 123/124 (see google docs!)

Mel meeting:
* lepton pt and njet bins
* TODO: Look at distributions in high lepton pt bin - see if everything is alright.
* Tight isolation issue: add ptcone/etcone plots, as well as relative plots
* MET resolution near 25 GeV

roofit:
Check that Z TP errors don't change if I scale the lumi by a factor of 10
   (or alternatively, if I actually normalize the histograms)

charge mis-id - won't work from Z's. Flip probability. Can't look at same-sign Z's
+ add bins of lepton pt
* TODO: use calo muons in tag-and-probe.

MCP mtg:
* understand systematics using special MC !!Validate the method by putting a shift by hand. Massimo will make samples
* run this method on MC directly
effect on the order of 0.2 TeV-1.

KS toy-MC study (performing a fit) - see if errors are correct. If yes, drop chi2 method.
For the "bad" cmb bin, look at a variation of akluit where the other muon is forced into a particular region.
Peter: does z resolution improve in data following the correction?

MCP:
Re-write db_* executable using classes that will automatically write out all latex output.
Basically, create python abstraction classes for every table. They can reference the database in the constructor.
Printing will occur in a correct manner automatically.
Use sequence of inheritance, starting from top-level document (that includes facilities to save and compile)
TODO: Z mass fit in bins of eta/phi - including on MC (confirm Kluit's problem)
      Z mass peak fit with alpgen; fit with/without pileup factors.
      Z mass peak at particle level (which is, however, after FSR/ISR)


TrigFTKAna:
* ID efficiency via tag and probe (lX, lY, lZ)
  Create a completely separate ntuple (manually turned on though). The idea is to create mu-ID candidates. The AOD::id muons would 
  have a link to the closest-matched full muon (if any). Make sure smearing class can smear ID muons, too!
* come up with a way to combine truth and reco ntuples:
  Keep default truth ntuples
  Add (if MC) additional words to primary ntuple: keeping relevant information from truth ntuple
  This would need some matching: for a given W/Z candidate, it will seek the closest truth candidate.

conversion to truth level. Resolution is not negligible in MET. unfolding.
Peter: METRefFinal - METTruth; split into parallel and perpendicular to lepton axis components (later)
Handle bad charge-dependent modeling - even though QCD is fit in a charge-dependent fasion.

Issues:
* choose generator that models missing et best (!!!)

Suggestions for analysis:
* z0/d0 vs nvtx plots
* charge mis-id plots
* z tag-probe vs muon p (not pt)
* add yields
* Efficiency unfolding - careful with different generators.

Suggestions for MCP:
* Add fitted-z-mass in phi/eta bins plot!
  https://indico.cern.ch/getFile.py/access?subContId=3&contribId=7&resId=1&materialId=slides&confId=157170
* Add p_cmb-p_ID feature
  https://indico.cern.ch/getFile.py/access?subContId=0&contribId=7&resId=0&materialId=slides&confId=157170

print keysfit id/exms string modification to make sure it is correct.
* Add data-driven QCD template capability to SuData

* Et-miss resolution study: use Z events; project on Z pt axis (Sam Whitehead's thesis)

Consider W+jets QCD templates

Muon scales:
* Investigate RooEggePdf - see if it is indeed compatible with my implementation!
  Test by fitting the same event!
* Applying absolute scale: perhaps going about it the wrong way? Use the KS statistic between data and MC
  to find the location of the peak?
* in zpeak.py: automatically apply defaults depending on region and type of muon!

MCP scales:
* Check if RooKeysPDF rho can be chosen smartly - Jahred's thesis.
* Repeat a study to verify sqrt(A*B) works if one leg in barrel, another in endcap
